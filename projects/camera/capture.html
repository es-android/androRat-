<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Capture Selfie</title>
</head>
<body>
<h2>Opening Camera...</h2>

<video id="video" autoplay playsinline style="width:320px; display:block; margin-top:20px;"></video>
<canvas id="canvas" style="display:none;"></canvas>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-storage-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>

<script>
// ----------------------------------------------
//  FIREBASE CONFIG
// ----------------------------------------------
const firebaseConfig = {
    apiKey: "AIzaSyBgIg7tbnGtSoeo0nHMn6IkeuvMp30ar9w",
    authDomain: "esrat-4e28f.firebaseapp.com",
    databaseURL: "https://esrat-4e28f-default-rtdb.firebaseio.com",
    projectId: "esrat-4e28f",
    storageBucket: "esrat-4e28f.appspot.com",
    messagingSenderId: "712315598095",
    appId: "1:712315598095:android:ed0f042ee1d5410dfb7a7a"
};

firebase.initializeApp(firebaseConfig);
const storage = firebase.storage();
const db = firebase.database();

const video = document.getElementById("video");
const canvas = document.getElementById("canvas");

// ----------------------------------------------
//  START CAMERA
// ----------------------------------------------
navigator.mediaDevices.getUserMedia({ video: true })
    .then(stream => {
        console.log("Camera stream received.");
        video.srcObject = stream;

        video.onloadedmetadata = () => {
            console.log("Video metadata loaded.");
            setTimeout(captureSelfie, 1000);
        };
    })
    .catch(err => {
        alert("Camera permission denied.");
        console.error(err);
    });

// ----------------------------------------------
//  CAPTURE IMAGE
// ----------------------------------------------
function captureSelfie() {
    if (video.videoWidth === 0 || video.videoHeight === 0) {
        console.log("Video not ready, retrying...");
        return setTimeout(captureSelfie, 300);
    }

    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;

    const ctx = canvas.getContext("2d");
    ctx.drawImage(video, 0, 0);

    console.log("Drawing frame to canvas...");

    canvas.toBlob(blob => {
        if (!blob) {
            console.error("âŒ canvas.toBlob failed");
            alert("Failed to capture image. Try again.");
            return;
        }

        console.log("Blob ready:", blob);
        uploadToFirebase(blob);
    }, "image/jpeg", 0.95);
}

// ----------------------------------------------
//  UPLOAD SELFIE
// ----------------------------------------------
function uploadToFirebase(blob) {
    const timestamp = Date.now();
    const filename = `selfies/${timestamp}.jpg`;

    const ref = storage.ref().child(filename);

    console.log("Uploading:", filename);

    ref.put(blob)
        .then(snapshot => snapshot.ref.getDownloadURL())
        .then(url => {
            // Save full object in DB
            return db.ref("selfies").push({
                url: url,
                filename: filename,
                timestamp: timestamp
            });
        })
        .then(() => {
            document.body.innerHTML = `
                <h2>Selfie Uploaded Successfully!</h2>
                <p><a href="gallery.html">View Gallery</a></p>
            `;
        })
        .catch(err => {
            console.error("UPLOAD ERROR:", err);
            alert("Upload failed.");
        });
}
</script>
</body>
</html>
