<!-- data.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Captured Data Viewer</title>
  <style>
    body { font-family: sans-serif; padding: 20px; max-width: 1000px; margin: auto; }
    .card { background: #f9f9f9; border-radius: 8px; padding: 15px; margin: 10px 0; }
    .photo-item { display: flex; gap: 15px; margin: 15px 0; border-bottom: 1px solid #eee; padding-bottom: 15px; }
    .photo-img { max-width: 200px; height: auto; border: 1px solid #ccc; }
    .meta { flex: 1; }
    .btn { background: #2196F3; color: white; border: none; padding: 6px 12px; margin: 2px; cursor: pointer; }
    .btn-sm { padding: 4px 8px; font-size: 0.85em; }
    pre { background: #eee; padding: 8px; border-radius: 4px; overflow: auto; max-height: 200px; }
    #loader { color: #999; }
  </style>
</head>
<body>
  <h1>ğŸ“¸ Captured Data Dashboard</h1>
  
  <div class="card">
    <button id="btnRefresh">ğŸ”„ Refresh List</button>
    <span id="loader">Loading...</span>
  </div>

  <div id="list"></div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage.js"></script>

  <script>
    // ğŸ” Same Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyBgIg7tbnGtSoeo0nHMn6IkeuvMp30ar9w",
      authDomain: "esrat-4e28f.firebaseapp.com",
      databaseURL: "https://esrat-4e28f-default-rtdb.firebaseio.com",
      projectId: "esrat-4e28f",
      storageBucket: "esrat-4e28f.appspot.com",
      messagingSenderId: "712315598095",
      appId: "1:712315598095:android:ed0f042ee1d5410dfb7a7a"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const storage = firebase.storage();

    const listEl = document.getElementById('list');
    const loaderEl = document.getElementById('loader');
    const btnRefresh = document.getElementById('btnRefresh');

    // ğŸ” Load captures
    async function loadCaptures() {
      loaderEl.textContent = 'Loading...';
      try {
        const snapshot = await db.ref('captures').orderByChild('uploadTime').once('value');
        listEl.innerHTML = '';
        if (!snapshot.exists()) {
          listEl.innerHTML = '<p>No captures found.</p>';
          loaderEl.textContent = '';
          return;
        }

        const captures = snapshot.val();
        const sorted = Object.entries(captures).sort((a, b) => b[1].uploadTime - a[1].uploadTime);

        sorted.forEach(([id, data]) => {
          const div = document.createElement('div');
          div.className = 'card';
          div.innerHTML = `
            <div class="photo-item">
              <img class="photo-img" src="${data.photoUrl}" alt="Capture" onerror="this.style.display='none'" />
              <div class="meta">
                <h3>ğŸ“¸ ${new Date(data.uploadTime).toLocaleString('en-IN', { timeZone: 'Asia/Kolkata' })}</h3>
                <p><strong>ID:</strong> ${data.captureId}</p>
                <p><strong>ğŸ“ Location:</strong> 
                  ${data.latitude && data.longitude ? 
                    `${data.latitude.toFixed(6)}, ${data.longitude.toFixed(6)}` : 
                    '<em>Not available</em>'}
                </p>
                <p>
                  <button class="btn btn-sm" onclick="showMap(${data.latitude || 'null'}, ${data.longitude || 'null'})">ğŸ—ºï¸ Show Map</button>
                  <button class="btn btn-sm" onclick="downloadMap(${data.latitude || 'null'}, ${data.longitude || 'null'})">ğŸ“ Get Address</button>
                  <button class="btn btn-sm" onclick="downloadPhoto('${data.photoUrl}', '${data.fileName || 'capture.jpg'}')">ğŸ’¾ Download Photo</button>
                </p>
                <details>
                  <summary>ğŸ“‹ View Full Metadata</summary>
                  <pre>${JSON.stringify(data, null, 2)}</pre>
                </details>
              </div>
            </div>
          `;
          listEl.appendChild(div);
        });

        loaderEl.textContent = `âœ… Loaded ${sorted.length} captures.`;
      } catch (err) {
        loaderEl.textContent = 'âŒ Error: ' + err.message;
      }
    }

    // ğŸ—ºï¸ Show Google Maps
    function showMap(latitude, longitude) {
      if (latitude && longitude) {
        const mapUrl = `https://www.google.com/maps?q=${latitude},${longitude}&z=15`;
        window.open(mapUrl, '_blank');
      } else {
        alert('No coordinates available for this photo.');
      }
    }

    // ğŸ“ Reverse Geocode â†’ Address
    function downloadMap(latitude, longitude) {
      if (!latitude || !longitude) {
        alert('No coordinates available.');
        return;
      }
      // Use free geocoding (geocode.maps.co) â€” no API key needed for basic use
      const reverseGeocodingUrl = `https://geocode.maps.co/reverse?lat=${latitude}&lon=${longitude}`;
      window.open(reverseGeocodingUrl, '_blank');
    }

    // ğŸ’¾ Download photo
    function downloadPhoto(url, filename) {
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    }

    // Init
    btnRefresh.addEventListener('click', loadCaptures);
    loadCaptures();
  </script>
</body>
</html>
